<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UnicornsRHardcore2</title>
  <style>
    body {
      font-family: monospace;
      background-color: #1e1e1e;
      color: #f0f0f0;
      margin: 0;
      padding: 15px;
      height: 100vh;
      box-sizing: border-box;
      display: grid;
      grid-template-rows: 1fr auto auto;
      gap: 10px;
      overflow: hidden;
    }
    #title{
      width: 50%;
      height: auto;
      margin-bottom: 8px;
      display: block;
    }
    #output {
      display: flex;
      height: 100%;
      margin-bottom: 0;
      min-height: 200px;
    }
    .outputWindow{
      background: #2b2b2b;
      width: 70%;
      height: 100%;
      padding-left: 10px;
      scroll-padding: 10px;
      overflow-y: auto;
      border: 1px solid #444;
      margin-right: 10px;
      margin-bottom: 10px;
      white-space: pre-wrap;
    }
    .outputMap {
      width: 30%;
      height: 100%;
      border: 1px solid #444;
      white-space: pre-wrap;
      margin-bottom: 10px;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .player-marker {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 50px;
      color: #c75252;
      text-shadow: 
        -1px -1px 0 #fff,
        1px -1px 0 #fff,
        -1px 1px 0 #fff,
        1px 1px 0 #fff,
        -2px 0 0 #fff,
        2px 0 0 #fff,
        0 -2px 0 #fff,
        0 2px 0 #fff;
      z-index: 1000;
      display: none;
      transition: all 0.3s ease;
      pointer-events: none;
    }
    .middle-section {
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: fit-content;
    }
    #menu{
      display: none;
      gap: 10px;
      flex-wrap: wrap;
    }
    .menuItem {
      width: fit-content;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #444;
      font-family: monospace;
      font-size: 1em;
      background-color: #333;
      color: #fff;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .fade-in {
      animation: fadeIn 5s ease-out forwards;
    }
    #nameInput, #command {
      width: 99%;
      padding: 10px;
      border: none;
      font-family: monospace;
      font-size: 1em;
      background-color: #333;
      color: #fff;
      margin-bottom: 10px;
    }
    #footer{
      height: 25vh;
      min-height: 140px;
      max-height: 200px;
      margin: 0;
      padding: 3px;
      border: 1px solid #444;
      background-image: url("images/nightskyascii.png");
      background-position: center;
      background-size: cover; 
      background-repeat: no-repeat;
      overflow: hidden;
    }
    #gameover {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-image: url("images/nightskyascii.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      color: #ff6b6b;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      font-family: monospace;
    }
    
    #gameover pre {
      text-align: center;
      font-size: 1.2em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      animation: fadeIn 5s ease-out forwards;
    }
    
    #gameover .reload-hint {
      margin-top: 20px;
      font-size: 1em;
      color: #ffd93d;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    }
    
    #win {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-image: url("images/nightskyascii.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      color: #4CAF50;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      font-family: monospace;
    }
    
    #win pre {
      text-align: center;
      font-size: 1.2em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      animation: fadeIn 5s ease-out forwards;
    }
    
    #win .reload-hint {
      margin-top: 20px;
      font-size: 1em;
      color: #ffd93d;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    }
  </style>
</head>
<body>
  <!--<img id="title" img src="/images/titleascii.png" alt="Game Logo">-->
  <div id="output">
    <div class="outputWindow">
    This is your first step into a strange adventure.
    What is your name?
  </div>
    <div class="outputMap">
      <span class="player-marker" id="playerMarker">♞</span>
      no map available for this area
    </div>
  </div>

  <div class="middle-section">
    <div id="menu">
      <div class="menuItem">north</div>
      <div class="menuItem">south</div>
      <div class="menuItem">east</div>
      <div class="menuItem">west</div>
      <div class="menuItem">inspect</div>
      <div class="menuItem">inventory</div>
      <div class="menuItem">inspect [itemName]</div>
      <div class="menuItem">give [itemName]</div>
      <div class="menuItem">talk [npcName]</div>
      <div class="menuItem">attack [npcName]</div>
    </div>

    <input type="text" id="nameInput" placeholder="Enter your name" autofocus />
    <input type="text" id="command" placeholder="Enter your command" style="display:none;" />
  </div>

  <div id="footer">
    <pre>
       .   ____          _            __ _ _
      /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
     ( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
      \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
       '  |____| .__|_| |_|_| |_\__, | / / / /
      =========|_|==============|___/=/_/_/_/
      :: Spring Boot ::                (v3.2.5)

      :: Alba Pläp Golfe ::
      :: 2025 ::
    </pre>
  </div>

<div id="gameover">
  <pre>
 _______ _______ _______ _______      _______ ___ ___ _______ ______ 
|     __|   _   |   |   |    ___|    |       |   |   |    ___|   __ \
|    |  |       |       |    ___|    |   -   |   |   |    ___|      <
|_______|___|___|__|_|__|_______|    |_______|\\\___/|_______|___|\_|

    Your adventure ends here...
    
    <span id="death-cause"></span>
    <span id="combat-status"></span>
    
    :: Spring Boot ::                (v3.2.5)
    :: Alba Pläp Golfe ::
    :: 2025 ::
  </pre>
  <div class="reload-hint">Reload website to play again!</div>
</div>

<div id="win">
  <pre>
 ___ ___ _______ _______      ________ _______ _______ __ 
|   |   |       |   |   |    |  |  |  |_     _|    |  |  |
 \     /|   -   |   |   |    |  |  |  |_|   |_|       |__|
  |___| |_______|_______|    |________|_______|__|____|__|

    Your game developer got tired and your adventure ends here for now...
    Thank you for playing!
    
    <span id="win-message"></span>
    
    :: Spring Boot ::                (v3.2.5)
    :: Alba Pläp Golfe ::
    :: 2025 ::
  </pre>
  <div class="reload-hint">Reload website to play again!</div>
</div>

  <script>
    const output = document.querySelector('.outputWindow');
    const outputMap = document.querySelector('.outputMap');
    const nameInput = document.getElementById('nameInput');
    const commandInput = document.getElementById('command');
    const playerMarker = document.getElementById('playerMarker');
    
    // Function to position player marker based on chapter name
    function positionPlayerMarker(chapterName) {
      const marker = document.getElementById('playerMarker');
      if (!marker) return;
      
      console.log('Positioning marker for chapter:', chapterName);
      
      // Define positions as percentages of the map area (3x3 grid)
      const positions = {
        'City Outskirt South': { top: '83%', left: '50%' },     // bottom mid
        'City Outskirt South East': { top: '83%', left: '83%' }, // bottom right
        'City Outskirt South West': { top: '83%', left: '17%' }, // bottom left
        'City Outskirt East': { top: '50%', left: '83%' },      // mid right
        'City Outskirt West': { top: '50%', left: '17%' },       // mid left
        'Sweetopolis Citygate South': { top: '62%', left: '50%' },
        'Willow Tree Forest': { top: '47%', left: '99%' }
      };
      
      if (positions[chapterName]) {
        console.log('Found position for', chapterName, positions[chapterName]);
        marker.style.top = positions[chapterName].top;
        marker.style.left = positions[chapterName].left;
        marker.style.transform = 'translate(-50%, -50%)';
      } else {
        console.log('No specific position for', chapterName, '- using center');
        // Default center position for unknown chapters
        marker.style.top = '50%';
        marker.style.left = '50%';
        marker.style.transform = 'translate(-50%, -50%)';
      }
    }
    
    function showGameOver(deathMessage = '', combatStatus = '') {
      document.getElementById('gameover').style.display = 'flex';
      
      // Display death cause if provided
      const deathCauseElement = document.getElementById('death-cause');
      if (deathMessage) {
        deathCauseElement.textContent = deathMessage;
        deathCauseElement.style.color = '#ff9999';
        deathCauseElement.style.fontStyle = 'italic';
        deathCauseElement.style.display = 'block';
        deathCauseElement.style.marginBottom = '10px';
      }
      
      // Display combat status if provided
      const combatStatusElement = document.getElementById('combat-status');
      if (combatStatus) {
        combatStatusElement.textContent = combatStatus;
        combatStatusElement.style.color = '#ffcc66';
        combatStatusElement.style.fontFamily = 'monospace';
        combatStatusElement.style.whiteSpace = 'pre-line';
        combatStatusElement.style.display = 'block';
        combatStatusElement.style.marginBottom = '15px';
        combatStatusElement.style.fontSize = '0.9em';
      }
      
      commandInput.disabled = true;
      commandInput.style.display = 'none';
      document.getElementById('menu').style.display = 'none';
    }

    function showWin(winMessage = '') {
      document.getElementById('win').style.display = 'flex';
      
      // Display win message if provided
      const winMessageElement = document.getElementById('win-message');
      if (winMessage) {
        winMessageElement.textContent = winMessage;
        winMessageElement.style.color = '#90EE90';
        winMessageElement.style.fontFamily = 'monospace';
        winMessageElement.style.whiteSpace = 'pre-line';
        winMessageElement.style.display = 'block';
        winMessageElement.style.marginBottom = '15px';
        winMessageElement.style.fontSize = '0.95em';
        winMessageElement.style.textAlign = 'center';
        winMessageElement.style.lineHeight = '1.4';
      }
      
      commandInput.disabled = true;
      commandInput.style.display = 'none';
      document.getElementById('menu').style.display = 'none';
    }

    nameInput.addEventListener('keydown', async function (e) {
      if (e.key === 'Enter') {
        const name = nameInput.value.trim();
        if (!name) return;

        output.textContent += `\n> ${name}`;
        nameInput.style.display = 'none';
        commandInput.style.display = 'block';
        const menu = document.getElementById('menu');
        menu.style.display= 'flex';
        menu.classList.add('fade-in');
        commandInput.focus();

        const res = await fetch('http://localhost:8080/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(name)
        });

        const introText = await res.text();
        output.textContent += `\n${introText}`;
        output.scrollTop = output.scrollHeight;
        
        // Fetch initial map info and position marker
        fetch('http://localhost:8080/mapinfo', {
          method: 'POST'
        })
        .then(response => response.text())
        .then(mapInfo => {
          console.log('Initial map info:', mapInfo);
          const [mapBackground, chapterName] = mapInfo.split('|');
          
          if (mapBackground.startsWith("#")) {
            // No map available - show no map available for this area and hide player marker
            outputMap.style.background = mapBackground;
            outputMap.innerHTML = '<span class="player-marker" id="playerMarker">♞</span>no map available for this area';
            document.getElementById('playerMarker').style.display = 'none';
          } else {
            // Map is available - show map and player marker
            outputMap.style.background = `url(${mapBackground})`;
            outputMap.style.backgroundSize = "cover";
            outputMap.style.backgroundPosition = "center";
            outputMap.innerHTML = '<span class="player-marker" id="playerMarker">♞</span>';
            const marker = document.getElementById('playerMarker');
            marker.style.display = 'block';
            
            // Position the marker based on current chapter
            positionPlayerMarker(chapterName);
          }
        })
        .catch(error => {
          console.error('Error fetching initial map info:', error);
        });
      }
    });

    commandInput.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
      const command = commandInput.value;
      commandInput.value = '';
      output.textContent += `\n> ${command}`;
      output.scrollTop = output.scrollHeight;

      // ✅ Send to backend
      fetch('http://localhost:8080/command', {
        method: 'POST',
        headers: {
          'Content-Type': 'text/plain'
        },
        body: command
      })
      .then(response => response.text())
      .then(data => {
        output.textContent += `\n${data}`;
        output.scrollTop = output.scrollHeight;
        
        // Check if player died (game over)
        if (data.includes("GAME OVER")) {
          // Show the full game over message instead of just extracting death cause
          showGameOver(data.replace(/\n> .*/g, '').trim(), '');
          return;
        }
        
        // Check if player won
        if (data.includes("YOU WIN")) {
          // Extract win message if present
          const winMessageMatch = data.match(/WIN_MESSAGE: ([\s\S]*?)(?=\nYOU WIN|$)/);
          const winMessage = winMessageMatch ? winMessageMatch[1] : '';
          showWin(winMessage);
          return;
        }

      fetch('http://localhost:8080/mapinfo', {
        method: 'POST'
      })
      .then(response => response.text())
      .then(mapInfo => {
        console.log('Command map info:', mapInfo);
        const [mapBackground, chapterName] = mapInfo.split('|');
        
        if (mapBackground.startsWith("#")) {
          // No map available - show no map available for this area and hide player marker
          outputMap.style.background = mapBackground;
          outputMap.innerHTML = '<span class="player-marker" id="playerMarker">♞</span>no map available for this area';
          document.getElementById('playerMarker').style.display = 'none';
        } else {
          // Map is available - show map and player marker
          outputMap.style.background = `url(${mapBackground})`;
          outputMap.style.backgroundSize = "cover";
          outputMap.style.backgroundPosition = "center";
          outputMap.innerHTML = '<span class="player-marker" id="playerMarker">♞</span>';
          const marker = document.getElementById('playerMarker');
          marker.style.display = 'block';
          
          // Position the marker based on current chapter
          positionPlayerMarker(chapterName);
        }
      });
      })

      .catch(error => {
        output.textContent += `\n[Error communicating with server]`;
      });
    }
  });
  </script>
</body>
</html>